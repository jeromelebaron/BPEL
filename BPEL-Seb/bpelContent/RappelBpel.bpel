<!-- RappelBpel BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Fri May 20 10:13:45 CEST 2016 -->
<bpel:process name="RappelBpel"
         targetNamespace="http://rappel.bpel.afcepf.fr"
         suppressJoinFailure="yes"
         xmlns:tns="http://rappel.bpel.afcepf.fr"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:ns="http://un.service.afcepf.fr" xmlns:ns0="http://deux.service.afcepf.fr" xmlns:ns1="http://trois.service.afcepf.fr" xmlns:ns2="http://www.w3.org/2001/XMLSchema">

    <!-- Import the client WSDL -->
    <bpel:import namespace="http://trois.service.afcepf.fr" location="service3.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import namespace="http://deux.service.afcepf.fr" location="service2.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import namespace="http://un.service.afcepf.fr" location="service1.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import location="RappelBpelArtifacts.wsdl" namespace="http://rappel.bpel.afcepf.fr" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
         
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <bpel:partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <bpel:partnerLink name="client"
                     partnerLinkType="tns:RappelBpel"
                     myRole="RappelBpelProvider"
                     />
        
        <bpel:partnerLink name="service1" partnerLinkType="tns:PL1" partnerRole="PL1Role"></bpel:partnerLink>
        <bpel:partnerLink name="service2" partnerLinkType="tns:PL2" partnerRole="PLRole"></bpel:partnerLink>
        <bpel:partnerLink name="service3" partnerLinkType="tns:PL3" partnerRole="PLRole3"></bpel:partnerLink>
    </bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables>
        <!-- Reference to the message passed as input during initiation -->
        <bpel:variable name="input"
                  messageType="tns:RappelBpelRequestMessage"/>
                  
        <!-- 
          Reference to the message that will be returned to the requester
          -->
        <bpel:variable name="output"
                  messageType="tns:RappelBpelResponseMessage"/>
        <bpel:variable name="service1Response" messageType="ns:methodeServiceUnResponse"></bpel:variable>
        <bpel:variable name="service1Request" messageType="ns:methodeServiceUn"></bpel:variable>
        <bpel:variable name="service2Response" messageType="ns0:methodeServiceDeuxResponse"></bpel:variable>
        <bpel:variable name="service2Request" messageType="ns0:methodeServiceDeux"></bpel:variable>
        <bpel:variable name="service3Response" messageType="ns1:methodeServiceTroisResponse"></bpel:variable>
        <bpel:variable name="service3Request" messageType="ns1:methodeServiceTrois"></bpel:variable>
        <bpel:variable name="varA" type="ns2:string"></bpel:variable>
    </bpel:variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:sequence name="main">
        
        <!-- Receive input from requester. 
             Note: This maps to operation defined in RappelBpel.wsdl 
             -->
        <bpel:receive name="receiveInput" partnerLink="client"
                 portType="tns:RappelBpel"
                 operation="process" variable="input"
                 createInstance="yes"/>
        
        <!-- Generate reply to synchronous request -->
        
        <bpel:flow name="Flow"><bpel:sequence name="Sequence">
                <bpel:assign validate="no" name="AssignPL3">
                    <bpel:copy>
                        <bpel:from><bpel:literal><tns:methodeServiceTrois xmlns:tns="http://trois.service.afcepf.fr" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"></tns:methodeServiceTrois>

</bpel:literal></bpel:from>
                        <bpel:to variable="service3Request" part="parameters"></bpel:to>
                    </bpel:copy>
                    
                </bpel:assign>
                
                <bpel:invoke name="InvokePL3" partnerLink="service3" operation="methodeServiceTrois" portType="ns1:IService3" inputVariable="service3Request" outputVariable="service3Response"></bpel:invoke>
            </bpel:sequence><bpel:sequence name="Sequence1">
                <bpel:if name="If">
                    <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$input.payload/tns:input='toto']]></bpel:condition>
                    <bpel:sequence>
                        <bpel:assign validate="no" name="AssignEntree1">
                            <bpel:copy>
                                <bpel:from><bpel:literal><tns:methodeServiceUn xmlns:tns="http://un.service.afcepf.fr" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"></tns:methodeServiceUn>

</bpel:literal></bpel:from>
                                <bpel:to variable="service1Request" part="parameters"></bpel:to>
                            </bpel:copy>
                            
                        </bpel:assign>
                        <bpel:invoke name="InvokePL1" partnerLink="service1" operation="methodeServiceUn" portType="ns:IService1" inputVariable="service1Request" outputVariable="service1Response"></bpel:invoke>
                        <bpel:assign validate="no" name="AssignSortiePL1">
                            <bpel:copy>
                                <bpel:from part="parameters" variable="service1Response"></bpel:from>
                                <bpel:to variable="varA"></bpel:to>
                            </bpel:copy>
                        </bpel:assign>
                    </bpel:sequence>
                    <bpel:else>
                        <bpel:sequence>
                            <bpel:assign validate="no" name="AssignEntree2">
                                
                                
                                
                                <bpel:copy>
                                    <bpel:from><bpel:literal><tns:methodeServiceDeux xmlns:tns="http://deux.service.afcepf.fr" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"></tns:methodeServiceDeux>

</bpel:literal></bpel:from>
                                    <bpel:to variable="service2Request" part="parameters"></bpel:to>
                                </bpel:copy>
                                
                            </bpel:assign>
                            <bpel:invoke name="InvokePL2" partnerLink="service2" operation="methodeServiceDeux" portType="ns0:IService2" inputVariable="service2Request" outputVariable="service2Response"></bpel:invoke>
                            <bpel:assign validate="no" name="AssignSortiePL2">
                                <bpel:copy>
                                    <bpel:from part="parameters" variable="service2Response"></bpel:from>
                                    <bpel:to variable="varA"></bpel:to>
                                </bpel:copy>
                            </bpel:assign>
                        </bpel:sequence>
                    </bpel:else>
                </bpel:if>
            </bpel:sequence></bpel:flow>
        <bpel:assign validate="no" name="AssignFinal"><bpel:copy>
                <bpel:from><bpel:literal xml:space="preserve"><tns:RappelBpelResponse xmlns:tns="http://rappel.bpel.afcepf.fr" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:a>toto</tns:a>
  <tns:b>titi</tns:b>
</tns:RappelBpelResponse>
</bpel:literal></bpel:from>
                <bpel:to variable="output" part="payload"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from variable="varA"></bpel:from>
                <bpel:to part="payload" variable="output">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:a]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
        
            <bpel:copy>
                <bpel:from part="parameters" variable="service3Response"></bpel:from>
                <bpel:to part="payload" variable="output">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:b]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>
        <bpel:reply name="replyOutput" 
               partnerLink="client"
               portType="tns:RappelBpel"
               operation="process" 
               variable="output"
               />
    </bpel:sequence>
</bpel:process>

